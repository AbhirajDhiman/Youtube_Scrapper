
{% extends "base.html" %}

{% block title %}Search Results - {{ keyword }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Results Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="text-primary mb-1">
                        <i class="fas fa-search me-2"></i>Search Results for "{{ keyword }}"
                    </h2>
                    <p class="text-muted mb-0">
                        Found {{ total_results }} channels
                        {% if filters %}
                        with applied filters
                        {% endif %}
                    </p>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i>New Search
                    </a>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('export_data', format='csv') }}">
                                <i class="fas fa-file-csv me-2"></i>Export as CSV
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('export_data', format='excel') }}">
                                <i class="fas fa-file-excel me-2"></i>Export as Excel
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('export_data', format='json') }}">
                                <i class="fas fa-file-code me-2"></i>Export as JSON
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Quota Status -->
            {% if quota_status %}
            <div class="alert alert-info mb-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <i class="fas fa-chart-bar me-2"></i>
                        <strong>API Usage:</strong> 
                        {{ quota_status.quota_used }} requests used, {{ quota_status.quota_remaining }} remaining
                    </div>
                    <div class="col-md-4 text-end">
                        {% if quota_status.quota_exceeded %}
                        <span class="badge bg-danger">Quota Exceeded</span>
                        {% elif quota_status.quota_remaining < 1000 %}
                        <span class="badge bg-warning">Low Quota</span>
                        {% else %}
                        <span class="badge bg-success">Good Quota</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Applied Filters -->
            {% if filters %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Applied Filters</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if filters.min_subscribers or filters.max_subscribers %}
                        <div class="col-md-3">
                            <strong>Subscribers:</strong> 
                            {{ filters.min_subscribers or '0' }} - {{ filters.max_subscribers or '∞' }}
                        </div>
                        {% endif %}
                        {% if filters.min_videos or filters.max_videos %}
                        <div class="col-md-3">
                            <strong>Videos:</strong> 
                            {{ filters.min_videos or '0' }} - {{ filters.max_videos or '∞' }}
                        </div>
                        {% endif %}
                        {% if filters.min_upload_frequency %}
                        <div class="col-md-3">
                            <strong>Upload Freq:</strong> {{ filters.min_upload_frequency }}+/week
                        </div>
                        {% endif %}
                        {% if filters.max_days_since_upload %}
                        <div class="col-md-3">
                            <strong>Last Upload:</strong> Within {{ filters.max_days_since_upload }} days
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Results Table -->
            <div class="card shadow">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="channelsTable" class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Channel</th>
                                    <th>Metrics</th>
                                    <th>Activity</th>
                                    <th>Contact Info</th>
                                    <th>Quality Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for channel in channels %}
                                <tr>
                                    <!-- Channel Info -->
                                    <td>
                                        <div class="d-flex align-items-start">
                                            {% if channel.thumbnail %}
                                            <img src="{{ channel.thumbnail }}" alt="Thumbnail" 
                                                 class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-1">
                                                    <a href="{{ channel.url }}" target="_blank" class="text-decoration-none">
                                                        {{ channel.title }}
                                                    </a>
                                                </h6>
                                                <small class="text-muted d-block">
                                                    {{ channel.description[:100] }}{% if channel.description|length > 100 %}...{% endif %}
                                                </small>
                                                {% if channel.country != 'Unknown' %}
                                                <span class="badge bg-secondary mt-1">{{ channel.country }}</span>
                                                {% endif %}
                                                {% if channel.custom_url %}
                                                <span class="badge bg-info mt-1">Verified</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>

                                    <!-- Metrics -->
                                    <td>
                                        <div class="text-center">
                                            <div class="mb-2">
                                                <i class="fas fa-users text-primary me-1"></i>
                                                <strong>{{ "{:,}".format(channel.subscriber_count) }}</strong>
                                                <small class="d-block text-muted">subscribers</small>
                                            </div>
                                            <div class="mb-2">
                                                <i class="fas fa-video text-success me-1"></i>
                                                <strong>{{ "{:,}".format(channel.video_count) }}</strong>
                                                <small class="d-block text-muted">videos</small>
                                            </div>
                                            <div>
                                                <i class="fas fa-eye text-info me-1"></i>
                                                <strong>{{ "{:,}".format(channel.view_count) }}</strong>
                                                <small class="d-block text-muted">total views</small>
                                            </div>
                                        </div>
                                    </td>

                                    <!-- Activity -->
                                    <td>
                                        {% set quality = channel.quality_metrics %}
                                        {% if quality %}
                                        <div class="text-center">
                                            <div class="mb-2">
                                                <i class="fas fa-clock text-warning me-1"></i>
                                                <strong>{{ quality.upload_frequency or 'N/A' }}</strong>
                                                <small class="d-block text-muted">uploads/week</small>
                                            </div>
                                            <div class="mb-2">
                                                <i class="fas fa-chart-line text-primary me-1"></i>
                                                <strong>{{ "{:,}".format(quality.avg_views) if quality.avg_views else 'N/A' }}</strong>
                                                <small class="d-block text-muted">avg views</small>
                                            </div>
                                            <div>
                                                <i class="fas fa-heart text-danger me-1"></i>
                                                <strong>{{ quality.avg_engagement_rate or 'N/A' }}%</strong>
                                                <small class="d-block text-muted">engagement</small>
                                            </div>
                                            {% if quality.last_upload_date %}
                                            <div class="mt-2">
                                                {% set days_ago = (moment().utc() - moment(quality.last_upload_date).utc()).days %}
                                                {% if days_ago < 7 %}
                                                <span class="badge bg-success">Active</span>
                                                {% elif days_ago < 30 %}
                                                <span class="badge bg-warning">Recent</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ days_ago }}d ago</span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% else %}
                                        <div class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <small>Loading...</small>
                                        </div>
                                        {% endif %}
                                    </td>

                                    <!-- Contact Info -->
                                    <td>
                                        {% set contact = channel.contact_info %}
                                        <div>
                                            <!-- Emails -->
                                            {% if contact.emails %}
                                            <div class="mb-2">
                                                <i class="fas fa-envelope text-primary me-1"></i>
                                                <span class="badge bg-primary">{{ contact.emails|length }} email(s)</span>
                                                <div class="mt-1">
                                                    {% for email in contact.emails[:2] %}
                                                    <small class="d-block text-muted">{{ email }}</small>
                                                    {% endfor %}
                                                    {% if contact.emails|length > 2 %}
                                                    <small class="text-muted">+{{ contact.emails|length - 2 }} more...</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endif %}

                                            <!-- Website -->
                                            {% if channel.website_url %}
                                            <div class="mb-2">
                                                <i class="fas fa-globe text-success me-1"></i>
                                                <a href="{{ channel.website_url }}" target="_blank" class="text-decoration-none">
                                                    <small>Website</small>
                                                </a>
                                            </div>
                                            {% endif %}

                                            <!-- Social Media -->
                                            {% if contact.social_media %}
                                            <div class="mb-2">
                                                {% for platform, handle in contact.social_media.items() %}
                                                <span class="badge bg-info me-1">{{ platform }}</span>
                                                {% endfor %}
                                            </div>
                                            {% endif %}

                                            <!-- Contact Quality Score -->
                                            {% set contact_score = (contact.emails|length * 3) + (contact.social_media|length * 2) + (1 if channel.website_url else 0) %}
                                            {% if contact_score > 0 %}
                                            <div class="mt-2">
                                                {% if contact_score >= 7 %}
                                                <span class="badge bg-success">High Contact</span>
                                                {% elif contact_score >= 4 %}
                                                <span class="badge bg-warning">Medium Contact</span>
                                                {% else %}
                                                <span class="badge bg-secondary">Low Contact</span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </td>

                                    <!-- Quality Score -->
                                    <td>
                                        {% set quality = channel.quality_metrics %}
                                        {% if quality %}
                                        {% set activity_score = (quality.upload_frequency or 0) * 2 %}
                                        {% set engagement_score = (quality.avg_engagement_rate or 0) * 5 %}
                                        {% set contact_score = (contact.emails|length * 3) + (contact.social_media|length * 2) %}
                                        {% set total_score = activity_score + engagement_score + contact_score %}
                                        
                                        <div class="text-center">
                                            <div class="mb-2">
                                                {% if total_score >= 20 %}
                                                <div class="badge bg-success fs-6">{{ "%.1f"|format(total_score) }}</div>
                                                <small class="d-block text-success">Excellent</small>
                                                {% elif total_score >= 10 %}
                                                <div class="badge bg-warning fs-6">{{ "%.1f"|format(total_score) }}</div>
                                                <small class="d-block text-warning">Good</small>
                                                {% else %}
                                                <div class="badge bg-secondary fs-6">{{ "%.1f"|format(total_score) }}</div>
                                                <small class="d-block text-muted">Fair</small>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Score Breakdown -->
                                            <div class="progress" style="height: 4px;">
                                                <div class="progress-bar bg-success" style="width: {{ (activity_score/20*100)|min(100) }}%"></div>
                                                <div class="progress-bar bg-primary" style="width: {{ (engagement_score/20*100)|min(100) }}%"></div>
                                                <div class="progress-bar bg-info" style="width: {{ (contact_score/20*100)|min(100) }}%"></div>
                                            </div>
                                            <small class="text-muted mt-1 d-block">Activity • Engagement • Contact</small>
                                        </div>
                                        {% else %}
                                        <div class="text-center text-muted">
                                            <small>Calculating...</small>
                                        </div>
                                        {% endif %}
                                    </td>

                                    <!-- Actions -->
                                    <td>
                                        <div class="btn-group-vertical btn-group-sm">
                                            <a href="{{ channel.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                            {% if channel.website_url %}
                                            <a href="{{ channel.website_url }}" target="_blank" class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-globe"></i>
                                            </a>
                                            {% endif %}
                                            <button class="btn btn-outline-info btn-sm" onclick="copyContactInfo('{{ loop.index0 }}')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="mb-3">Export Your Results</h5>
                            <div class="btn-group">
                                <a href="{{ url_for('export_data', format='csv') }}" class="btn btn-outline-success">
                                    <i class="fas fa-file-csv me-2"></i>CSV Export
                                    <small class="d-block">Perfect for CRM import</small>
                                </a>
                                <a href="{{ url_for('export_data', format='excel') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-file-excel me-2"></i>Excel Export
                                    <small class="d-block">Formatted spreadsheet</small>
                                </a>
                                <a href="{{ url_for('export_data', format='json') }}" class="btn btn-outline-info">
                                    <i class="fas fa-file-code me-2"></i>JSON Export
                                    <small class="d-block">API integration ready</small>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    $('#channelsTable').DataTable({
        "pageLength": 25,
        "order": [[ 4, "desc" ]], // Sort by quality score
        "columnDefs": [
            { "orderable": false, "targets": [5] } // Disable sorting for actions column
        ],
        "language": {
            "search": "Filter channels:",
            "lengthMenu": "Show _MENU_ channels per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ channels"
        }
    });
});

function copyContactInfo(index) {
    // This would copy contact information to clipboard
    // Implementation would depend on the specific data structure
    console.log('Copying contact info for channel index:', index);
    
    // You could implement clipboard functionality here
    navigator.clipboard.writeText('Contact info copied').then(function() {
        // Show toast or alert
        alert('Contact information copied to clipboard!');
    });
}

// Auto-refresh quality scores that are still loading
setTimeout(function() {
    location.reload();
}, 30000); // Refresh after 30 seconds to update any pending quality metrics
</script>
{% endblock %}
